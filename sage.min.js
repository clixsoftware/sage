/*
(c) Michael Phan-Ba
github.com/mikepb/snap
Apache License
*/(function(a,b,c,d){function g(a){var b,c,d=1;while(b=arguments[d++])for(c in b)a[c]=b[c];return a}function h(a){return Object.prototype.toString.call(a)}function i(a){return h(a)=="[object String]"}function j(a){return h(a)=="[object Object]"}function k(a){return h(a)=="[object Array]"}function l(a){return h(a)=="[object Function]"}function m(a){if(!a||i(a))return m.make(a);var b=[],c,d=0,e;for(c in a)a[c]=m.make(a[c]),b.push(c);return e=b.length,function(c){var f;c||(c=b[d++],d%=e);if(!(f=a[c]))throw new Error("no server configured");return f}}var e=this,f=this.sage;this.sage=m,a&&(a.exports=m),m.noConflict=function(){return e.sage=f,m},m.version="0.0.0",m.make=function(a){var b,c;a=m._parseURI(a);if(c=/^(https?:\/\/[^\/]+).*?(\/[^\/]+)?$/.exec(a.host))a.host=c[1],c=c[2]&&d(c[2]);return b=new m.Client(a.host,a),c?b.index(c):b},m._parseURI=function(a){var b;if(a){a=a.replace(/\/+/g,"/").replace(/\/+$/g,"");if(b=/^(https?:\/\/)(?:([^@:]+):([^@]+)@)?([^\/]+)(.*)$/.exec(a))return{host:b[1]+b[4],user:b[2]&&d(b[2]),pass:b[3]&&d(b[3])}}return{host:a||""}},m.Base={request:function(){var a=[].slice.call(arguments),b=l(a[a.length-1])&&a.pop(),c=a[4]||{},d=a[1]?"/"+a[1]:"";return"Content-Type"in c||(c["Content-Type"]="application/json"),this._request(a[0]||"GET",this.uri+d,a[2],a[3]&&JSON.stringify(a[3],/^\/_mapping/.test(d)&&this._replacer)||"",c,this.auth||{},b),this},_request:function(a,b,d,e,f,g,h){var i=this,j=new XMLHttpRequest,k=[],l,m;if(d){for(m in d)k.push(c(m)+"="+c(d[m]));k.length&&(b+="?"+k.join("&"))}j.open(a,b,!0,g.user,g.pass);if(f)for(l in f)j.setRequestHeader(l,f[l]);j.onreadystatechange=function(){if(h&&j.readyState===4){var b=i._getHeaders(j),c=j.responseText,d;if(a=="HEAD")c=b;else if(c)try{c=JSON.parse(c)}catch(e){d=e}d||(c=i._response(c)),h(d,c,j.status,b,j)}},j.send(e)},_response:function(a){return a},_replacer:function(a,b){return l(b)?b.toString():b},_meta:function(a){var b=!a.id^!a._id,c=!a.rev^!a._rev,d;if(b||c)d=g(a.__proto__={},a),b&&(d._id=a.id=a._id||a.id),c&&(d._rev=a.rev=a._rev||a.rev);return a},_headers:["cache-control","content-length","content-type","date","etag","server"],_getHeaders:function(a){var b={},c,d=0;while(c=this._headers[d++])b[c]=a.getResponseHeader(c);return b},_:function(a,c,d){function j(a,b,c){return c||(c={}),e.request(a,b||j.p,"q"in c?c.q:j.q,"b"in c?c.b:j.b,"h"in c?c.h:j.h,"f"in c?c.f:j.f),e}var e=this,f,g,h;a=[].slice.call(a,c),j.f=l(a[a.length-1])&&a.pop(),j.p=i(a[0])&&b(a.shift())||k(a[0])&&b(a.shift().join(",")),j.q=a[d?1:0]||{},j.h=a[d?2:1]||{};if(d)if(f=j.b=a[0]){if(g=j.p||f._id||f.id)j.p=g;if(h=j.q.rev||f._rev||f.rev)j.q.rev=h}return j}},m.Client=function(a,b){this.uri=a,this.auth=b,this._index={}},m.Client.prototype={index:function(a){var b=this._index;return i(a)&&(a=a.split(",")),a.sort(),a=a.join(","),b[a]||(b[a]=new m.Index(this,a,this.auth))},health:function(){return this._(arguments)("GET","_cluster/health")},state:function(){var a=this._(arguments);return a("GET","_cluster/state"+(a.p?"/"+a.p:""))},nodes:function(){var a=this._(arguments);return a("GET","_nodes"+(a.p?"/"+a.p:""))},stats:function(){var a=this._(arguments);return a("GET","_nodes"+(a.p?"/"+a.p:"")+"/stats")},shutdown:function(){var a=this._(arguments);return a("POST","_nodes"+(a.p?"/"+a.p:"")+"/_shutdown")},settings:function(){var a=this._(arguments,0,1);return a(a.b?"PUT":"GET","_cluster/settings")},template:function(){var a=this._(arguments,0,1);return a(a.b?"PUT":"GET","_template/"+a.p)}},m.Index=function(a,b,d){this.client=a,this.name=b,this.uri=a.uri+"/"+c(b),this.auth=d},m.Index.prototype={create:function(){return this._(arguments,0,1)("PUT")},destroy:function(){return this._(arguments)("DELETE")},exists:function(){var a=this._(arguments),b=a.f;return a.f=function(a,c,d,e,f){b(a,d===200,d,e,f)},a("HEAD")},get:function(){return this._(arguments)("GET")},head:function(){var a=this._(arguments),b=a.f,c=a.p,d;return a.f=function(a,e,f,g,h){b(a,a?e:{_id:c,id:c,_rev:d=g.etag&&JSON.parse(g.etag),rev:d,contentType:g["content-type"],contentLength:g["content-length"]},f,g,h)},a("HEAD")},post:function(a){return this._(arguments,1)("POST",0,{b:a})},put:function(){var a=this._(arguments,0,1);if(!a.p)throw new Error("missing id");return a("PUT")},del:function(a){if(k(a)){var b=0,c,d;for(c=a.length;b<c;b++)d=a[b],a[b]={_id:d._id||d.id,_rev:d._rev||d.rev,_deleted:!0};return this.bulk.apply(this,arguments)}var e=this._(arguments,0,1);if(!e.p)throw new Error("missing id");return e("DELETE")},all:function(){return this._(arguments,0,1)("GET")},bulk:function(){throw new Error("not implemented")},close:function(){return this._(arguments)("POST","_close")},open:function(){return this._(arguments)("POST","_open")},refresh:function(){return this._(arguments)("POST","_refresh")},flush:function(){return this._(arguments)("POST","_flush")},clear:function(){return this._(arguments)("GET","_cache/clear")},optimize:function(){return this._(arguments)("POST","_optimize")},snapshot:function(){return this._(arguments)("POST","_gateway/snapshot")},settings:function(){var a=this._(arguments,0,1);return a(a.b?"PUT":"GET","_settings")},map:function(){var a=this._(arguments,0,1);return a(a.b?"PUT":"GET",(a.p?a.p+"/":"")+"_mapping")},unmap:function(){var a=this._(arguments);return a("DELETE",(a.p?a.p+"/":"")+"_mapping")},stats:function(){return this._(arguments)("GET","_stats")},status:function(){return this._(arguments)("GET","_status")},segments:function(){return this._(arguments)("GET","_segments")}},m.Client.prototype.__proto__=m.Index.prototype.__proto__=m.Base})(typeof module!="undefined"&&module,encodeURI,encodeURIComponent,decodeURIComponent);