/*
(c) Michael Phan-Ba
github.com/mikepb/sage
Apache License
*/(function(a,b,c){function f(a){var b,c,d=1;while(b=arguments[d++])for(c in b)a[c]=b[c];return a}function g(a){return Object.prototype.toString.call(a)}function h(a){return g(a)=="[object String]"}function i(a){return g(a)=="[object Object]"}function j(a){return g(a)=="[object Array]"}function k(a){return g(a)=="[object Function]"}function l(a){return l.make(a)}var d=this,e=this.sage;this.sage=l,l.noConflict=function(){return d.sage=e,l},l.version="0.1.1",l.make=function(a){var b,d;return a=l._parseURI(a),a.path&&(d=/\/*([^\/]+)\/*$/.exec(a.path))&&(a.path=a.path.substr(0,d.index),d=d[1]&&c(d[1])),b=new l.Client(a.host+a.path,a),d?b.index(d):b},l._parseURI=function(a){var b;if(a)if(b=/^(https?:\/\/)(?:([^@:]+):([^@]+)@)?([^\/]+)(.*)\/*$/.exec(a))return{host:b[1]+b[4].replace(/\/+/g,"/"),path:b[5],user:b[2]&&c(b[2]),pass:b[3]&&c(b[3])};return{host:a||"",path:""}},l.Base=function(){},l.Base.prototype={request:function(){var a=[].slice.call(arguments),b=k(a[a.length-1])&&a.pop(),c=a[4]||{},d=a[1]?"/"+a[1]:"",e=a[3]||"";return e&&!/\/_bulk$/.test(d)&&(e=JSON.stringify(a[3],/^\/_mapping/.test(d)&&this._replacer)),"Content-Type"in c||(c["Content-Type"]="application/json"),this._request(a[0]||"GET",this.uri+d,a[2],e,c,this.auth||{},b),this},_request:function(a,c,d,e,f,g,h){var i=this,j=new XMLHttpRequest,k=[],l,m;if(d){for(m in d)k.push(b(m)+"="+b(d[m]));c+="?"+k.join("&")}j.open(a,c,!0,g.user,g.pass);if(f)for(l in f)j.setRequestHeader(l,f[l]);j.onreadystatechange=function(){if(h&&j.readyState===4){var b=i._getHeaders(j),c=j.responseText,d;if(a=="HEAD")c=b;else if(c)try{c=JSON.parse(c)}catch(e){d=e}!d&&c&&(c=i._response(c)),c&&c.error&&(d=new Error(c.error)),h(d,c,j.status,b,j)}},j.send(e)},_response:function(a){var b=a.items||a.hits&&a.hits.hits,c=this._meta,d=0,e;if(b){b=[].slice.call(b),f(b.__proto__=[],a,a.hits).json=a;for(e=b.length;d<e;d++)b[d]=c(b[d])}else b=c(a);return b},_replacer:function(a,b){return k(b)?b.toString():b},_meta:function(a){var b=!a.id^!a._id,c=!a.version^!a._version,d;if(b||c)d=f(a.__proto__={},a),b&&(d._id=a.id=a._id||a.id),c&&(d._version=a.version=a._version||a.version);return a},_headers:["cache-control","content-length","content-type","date","etag","server"],_getHeaders:function(a){var b={},c,d=0;while(c=this._headers[d++])b[c]=a.getResponseHeader(c);return b},_:function(b,c,d){function l(a,b,c){return c||(c={}),e.request(a,b||l.p||"","q"in c?c.q:l.q,"b"in c?c.b:l.b,"h"in c?c.h:l.h,"f"in c?c.f:l.f),e}var e=this,f,g,i;b=[].slice.call(b,c),l.f=k(b[b.length-1])&&b.pop(),l.p=h(b[0])&&a(b.shift())||j(b[0])&&a(b.shift().join(","))||"",l.q=b[d?1:0]||{},l.h=b[d?2:1]||{};if(d)if(f=l.b=b[0]){if(g=l.p||f._id||f.id)l.p=g;if(i=l.q.rev||f._rev||f.rev)l.q.rev=i}return l}},l.Client=function(a,b){this.uri=a,this.auth=b,this._indexes={}},l.Client.prototype=f(new l.Base,{index:function(a){var b=this._indexes;return h(a)&&(a=a.split(",")),a.sort(),a=a.join(","),b[a]||(b[a]=new l.Index(this,a,this.auth))},river:function(a){var b=this._(arguments,1,1);return b(b.b?"PUT":"GET","_river/"+a+"/_meta")},unriver:function(a){return this._(arguments,1)("DELETE","_river/"+a)},stats:function(){var a=this._(arguments);return a("GET","_nodes"+(a.p?"/"+a.p:"")+"/stats")},health:function(){return this._(arguments)("GET","_cluster/health")},state:function(){var a=this._(arguments);return a("GET","_cluster/state/"+(a.p||""))},nodes:function(){var a=this._(arguments);return a("GET","_nodes/"+(a.p||""))},config:function(){var a=this._(arguments,0,1);return a(a.b?"PUT":"GET","_cluster/settings")},tmpl:function(){var a=this._(arguments,0,1);return a(a.b?"PUT":"GET","_template/"+a.p)},untmpl:function(){var a=this._(arguments);return a("DELETE","_template/"+a.p)}}),l.Index=function(a,c,d){this.client=a,this.name=c,this.uri=a.uri+(c?"/"+b(c):""),this.auth=d,this._types={}},l.Index.prototype=f(new l.Base,{type:function(a){var b=this._types;return b[a]||(b[a]=new l.Type(this,a,this.auth))},create:function(){return this._(arguments,0,1)("PUT")},destroy:function(){return this._(arguments)("DELETE")},exists:function(){var a=this._(arguments),b=a.f;return a.f=function(a,c,d,e,f){b(a,d===200,d,e,f)},a("HEAD")},all:function(){return this._(arguments,0,1)("GET","_mget")},find:function(){return this._(arguments,0,1)("POST","_search")},close:function(){return this._(arguments)("POST","_close")},open:function(){return this._(arguments)("POST","_open")},refresh:function(){return this._(arguments)("POST","_refresh")},flush:function(){return this._(arguments)("POST","_flush")},clear:function(){return this._(arguments)("GET","_cache/clear")},optimize:function(){return this._(arguments)("POST","_optimize")},snapshot:function(){return this._(arguments)("POST","_gateway/snapshot")},settings:function(){var a=this._(arguments,0,1);return a(a.b?"PUT":"GET","_settings")},map:function(){var a=this._(arguments,0,1);return a(a.q?"PUT":"GET",(a.p?a.p+"/":"")+"_mapping")},unmap:function(){var a=this._(arguments);return a("DELETE",(a.p?a.p+"/":"")+"_mapping")},stats:function(){return this._(arguments)("GET","_stats")},status:function(){return this._(arguments)("GET","_status")},segments:function(){return this._(arguments)("GET","_segments")}}),l.Type=function(a,c,d){this.index=a,this.name=c,this.uri=a.uri+(c?"/"+b(c):""),this.auth=d},l.Type.prototype=f(new l.Base,{get:function(){return this._(arguments)("GET")},post:function(a){var b=this._(arguments,1),c,d,e,f,g="",h,i,k;if(j(a)){b.p="_bulk";for(h=0,i=a.length;h<i;h++){c=a[h],d={},e={},f=d[c._deleted?"delete":"index"]={};for(k in c)(k[0]=="_"?f:e)[k]=c[k];g+=JSON.stringify(d)+"\n"+JSON.stringify(c)+"\n"}}return b("POST",0,{b:g||a})},put:function(a){if(!this.name||!a._id)throw new Error("missing type or id");return this._(arguments,1)("PUT",a._id,{b:a})},del:function(a){if(j(a)){var b=0,c,d,e={};for(c=a.length;b<c;b++)d=a[b],e[b]={_index:d._index||d.index,_type:d._type||d.type,_id:d._id||d.id,_version:d._version||d.version,_deleted:!0};return a=e,this.post.apply(this,arguments)}if(!this.name||!a._id)throw new Error("missing type or id");return this._(arguments,1)("DELETE",a._id)}})})(encodeURI,encodeURIComponent,decodeURIComponent);